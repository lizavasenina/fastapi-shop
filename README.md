# FastAPI Shop
## О проекте
Разработано веб-приложение на FastAPI для управления заказами в онлайн-магазине мебели и бытовой техники. Пользователи могут регистрироваться, авторизироваться, создавать заказы, удалять невыполненные заказы, просматривать историю своих заказов и их статусы. Администраторы могут модифицировать любые записи, связанные как с заказами и пользователями, так и с товарами и категориями.

Поставлена задача оптимального заполнения грузовой машины заказами, представляющая собой задачу о рюкзаке: необходимо заполнить грузовую машину, вместимость которой ограничена, как можно большим числом заказов, включающих в себя товары заданного объёма. Ценность заказов определяется в соответствии с количеством погрузок, прошедших с начала добавления заказа: если при очередной погрузке заказ не был отправлен, его ценность увеличивается. Начальное значение ценности каждого заказа равно единице. Поставленная задача решена методом ветвей и границ.

Все HTTP-запросы покрыты автоматическими тестами на основе TestClient.

## HTTP-запросы
Имеет доступ незарегистрированный пользователь:
* **GET** `/products/{product_id}` - получить информацию о товаре
* **GET** `/products/` - получить информацию обо всех товарах
* **GET** `/categories/{category_id}` - получить информацию о категории товаров
* **GET** `/categories/` - получить информацию обо всех категориях товаров
* **POST** `/auth/register` - зарегистрироваться

Имеет доступ зарегистрированный пользователь:
* **GET** `/users/{user_id}` - получить информацию о пользователе
* **PUT** `/users/{user_id}` - изменить информацию о пользователе
* **DELETE** `/users/{user_id}` - удалить пользователя
* **GET** `/orders/{order_id}` - получить информацию о заказе
* **GET** `/orders/` - получить информацию о заказах пользователя
* **DELETE** `/orders/{order_id}` - удалить заказ
* **POST** `/orders/` - создать заказ
* **GET** `/order_items/{order_item_id}` - получить информацию о позиции заказа
* **GET** `/order_items/` - получить все позиции всех заказов пользователя
* **PUT** `/order_items/{order_item_id}` - изменить информацию о позиции заказа
* **POST** `/order_items/` - создать позицию заказа
* **DELETE** `/order_items/{order_item_id}` - удалить позицию заказа
* **POST** `/auth/login` - авторизироваться
* **POST** `/auth/logout` - разлогиниться

Имеет доступ администратор:
* **GET** `/users/` - получить информацию обо всех пользователях
* **PUT** `/products/{product_id}` - изменить информацию о товаре
* **DELETE** `/products/{product_id}` - удалить товар
* **POST** `/products/` - добавить товар
* **PATCH** `/products/{product_id}` - изменить запас товара
* **GET** `/orders/` - получить информацию обо всех заказах
* **PUT** `/orders/{order_id}` - изменить заказ
* **POST** `/orders/{user_id}` - создать заказ
* **GET** `/order_items/` - получить все позиции всех заказов
* **PUT** `/categories/{category_id}` - изменить информацию о категории товаров
* **POST** `/categories/` - добавить новую категорию товаров
* **DELETE** `/categories/` - удалить категорию товаров
* **GET** `/task/` - решить задачу оптимального заполнения грузовой машины заказами
* **PUT** `/auth/admin/{user_id}` - назначить пользователя администратором

## Требования
Для запуска приложения потребуется:
* Python 3
* PostgreSQL 17.4
* Docker
* Docker Compose

## Установка и настройка
### Запуск через Docker
**1. Склонируйте репозиторий:**
```bash
git clone https://github.com/lizavasenina/fastapi-shop.git
```

**2. В .env укажите POSTGRES_USER и POSTGRES_PASSWORD.**

**3. Соберите и запустите docker-compose:**
```bash
docker-compose up
```

**4. Подключитесь к серверу по адресу:**
```bash
http://localhost:8080/docs
```

### Запуск без использования Docker
**1. Склонируйте репозиторий:**
```bash
git clone https://github.com/lizavasenina/fastapi-shop.git
```

**2. В .env укажите POSTGRES_USER и POSTGRES_PASSWORD, замените значение POSTGRES_HOST на localhost.**

**3. Перейдите в папку app и запустите приложение:**
```bash
cd app
uvicorn main:app
```

**4. Подключитесь к серверу по адресу:**
```bash
http://localhost:8000/docs
```

**5. Запустите тесты:**
```bash
pytest tests
```

## Структура проекта
```
fastapi-shop /
│   .env                                       # Файл для хранения переменных окружения
│   alembic.ini                                # Инструмент для миграций
│   docker-compose.yml                         # Файл для описания docker-контейнеров
│   Dockerfile                                 # Dockerfile для app
│   pytest.ini                                 # Конфигурационный файл для тестов
│   requirements.txt                           # Необходимые зависимости
│
├───app                                        # Приложение
│   │   config.py                              # Файл для хранения конфигурации проекта
│   │   dependencies.py                        # Модуль для создания сессии
│   │   main.py                                # Главный файл приложения
│   │   models.py                              # Классы моделей
│   │   \__init__.py
│   │
│   ├───auth
│   │       auth_handler.py                    # Модуль для настройки аутентификации
│   │       \__init__.py
│   │
│   ├───db
│   │       database.py                        # Модуль для настройки подключения к БД
│   │
│   ├───migrations                             # Миграции
│   │   │   env.py                             # Конфигурационный файл миграций
│   │   │   README
│   │   │   script.py.mako
│   │   │
│   │   └───versions
│   │           b6a3585093d4_create_tables.py  # Миграция для создания таблиц
│   │
│   ├───routers                                # Роутеры API
│   │       auth.py                            # Роутер авторизации
│   │       category.py                        # Роутер категорий
│   │       order.py                           # Роутер заказов
│   │       order_item.py                      # Роутер позиций заказов
│   │       product.py                         # Роутер товаров
│   │       task.py                            # Роутер для решения задачи оптимизации
│   │       user.py                            # Роутер пользователей
│   │       \__init__.py
│   │
│   ├───schemas                                # Схемы Pydantic
│   │       category.py                        # Схемы Pydantic для категорий
│   │       order.py                           # Схемы Pydantic для заказов
│   │       order_item.py                      # Схемы Pydantic для позиций заказов
│   │       product.py                         # Схемы Pydantic для товаров
│   │       user.py                            # Схемы Pydantic для пользователей
│   │
│   └───services                               # Сервисы для сущностей
│           category_service.py                # Сервис категорий
│           order_item_service.py              # Сервис позиций заказов
│           order_service.py                   # Сервис заказов
│           product_service.py                 # Сервис товаров
│           task_service.py                    # Сервис задачи оптимизации
│           user_service.py                    # Сервис пользователей
│
└───tests                                      # Тесты
    │   \__init__.py
    │
    ├───admin_auth                             # Тесты при авторизованном администраторе
    │       conftest.py                        # Конфигурационный файл тестов
    │       test_categories_admin.py           # Тесты категорий
    │       test_orders_admin.py               # Тесты заказов
    │       test_order_items_admin.py          # Тесты позиций заказов
    │       test_products_admin.py             # Тесты товаров
    │       test_users_admin.py                # Тесты пользователей
    │
    ├───auth                                   # Тесты роутера авторизации
    │       conftest.py                        # Конфигурационный файл тестов
    │       test_auth.py                       # Тесты авторизации
    │
    ├───no_auth                                # Тесты при неавторизованном пользователе
    │       conftest.py                        # Конфигурационный файл тестов
    │       test_categories.py                 # Тесты категорий
    │       test_orders.py                     # Тесты заказов
    │       test_order_items.py                # Тесты позиций заказов
    │       test_products.py                   # Тесты товаров
    │       test_users.py                      # Тесты пользователей
    │
    └───user_auth                              # Тесты при авторизованном пользователе
            conftest.py                        # Конфигурационный файл тестов
            test_categories_user.py            # Тесты категорий
            test_orders_user.py                # Тесты заказов
            test_order_items_user.py           # Тесты позиций заказов
            test_products_user.py              # Тесты товаров
            test_users_user.py                 # Тесты пользователей
```